<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="Furrybear">
    <link rel="canonical" href="https://furrybear.readthedocs.com/1. Knowledge of Blockchain/比特币学习笔记/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>比特币学习笔记 - Furrybear's Blog</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u6bd4\u7279\u5e01\u5b66\u4e60\u7b14\u8bb0", url: "#_top", children: [
              {title: "\u6bd4\u7279\u5e01\u5730\u5740", url: "#_2" },
              {title: "\u4ea4\u6613", url: "#_3" },
              {title: "\u9694\u79bb\u89c1\u8bc1\uff08segregated witness\uff09", url: "#segregated-witness" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../比特币脚本与地址学习笔记/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../比特币脚本与地址学习笔记/" class="btn btn-xs btn-link">
        比特币脚本与地址学习笔记
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../常见活跃区块链/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../常见活跃区块链/" class="btn btn-xs btn-link">
        常见区块链项目
      </a>
    </div>
    
  </div>

    

    <h1 id="_1">比特币学习笔记</h1>
<h2 id="_2">比特币地址</h2>
<p>比特币使用Secp256k1椭圆曲线得到私钥、公钥。</p>
<p>公钥哈希是公钥进行HASH160（SHA256、RIPEMD160）而来的，为了方便阅读，再对公钥哈希使用BASE58CHECK编码成地址来显示。但是账本上是不会出现“地址”，只会出现公钥（解锁脚本里）和公钥哈希（锁定脚本里）。</p>
<p>地址是公钥哈希或者脚本哈希进行check58num或者bech32编码后的结果。</p>
<h2 id="_3">交易</h2>
<h3 id="coinbase">非coinbase交易</h3>
<p><img alt="" src="https://raw.githubusercontent.com/furrybear/res/master/img/20190302101425.png" /></p>
<p>交易中的script可以看做是一个下推自动机的的形式语言，用来对栈进行存取和处理。</p>
<h3 id="coinbase_1">coinbase交易</h3>
<p>coinbase交易中的输入结构和普通交易不一样。</p>
<h3 id="lock_time">交易结构中的lock_time</h3>
<p>交易中的lock_time指示这笔交易在哪个时间才可以出现在链上。</p>
<h3 id="minrelaytxfee">minrelaytxfee</h3>
<p>一个节点有minrelaytxfee参数，现在版本默认为0.00001btc，可以修改，交易费低于minrelaytxfee的交易不会被转发。</p>
<h3 id="transaction-malleability">交易延展性（transaction malleability）</h3>
<p>参考：</p>
<ul>
<li><a href="https://bitcoincore.org/en/2016/01/26/segwit-benefits/">https://bitcoincore.org/en/2016/01/26/segwit-benefits/</a> </li>
<li><a href="https://en.bitcoin.it/wiki/Transaction_malleability">https://en.bitcoin.it/wiki/Transaction_malleability</a></li>
</ul>
<p>隔离见证可以解决交易延展性（transaction malleability）。</p>
<p>交易发送方可以将签名好的交易发送给比特币网络，并且可以计算出这笔交易的txid（用HASH256，即两次SHA256）。txid是交易在链上的唯一标志。</p>
<p>但是在交易进入共识链之前，被转发或者被矿工处理的过程中，内容可以被改变（但无法改变输入和输出），造成txid被改变。交易发送方无法按txid追索到自己发的交易。这称为第三方延展性（third-party malleability）。</p>
<h3 id="signature-malleability">签名延展性（Signature Malleability）</h3>
<p>交易的输入中的每个输入的解锁脚本中有签名（ECDSA算法生成），攻击者可以在不掌握交易发送方的私钥（这个输入引用的输出的锁定脚本中的公钥哈希对应的私钥）的情况下重构一个不一样的但是合法的签名，造成txid的改变。主要原因是openssl不要求签名严格遵循DER-encoded ASN.1标准，BIP66软分叉要求签名严格遵守DER-encoded ASN.1标准以避免这个问题（看了DER编码和椭圆曲线，但是没大懂）。</p>
<p>采用隔离验证形式的新式交易将签名移到交易的script_witnesses字段，避免了这个问题。</p>
<h3 id="scriptsig-malleability">解锁脚本延展性（scriptSig Malleability）</h3>
<blockquote>
<p>The signature algorithm used in Bitcoin does not sign any of the scriptSig to create the signature. While signing the whole scriptSig would be impossible - the signature would be signing itself - this does mean that additional data can be added such that it will be pushed on the stack prior to the required signatures and public keys. Similarly OP_DROP can be added to leave the stack exactly as before prior to scriptPubKey execution.</p>
<p>Preventing scriptSig malleability is being considered as well. Currently transactions with anything other than data push operations in their scriptSig are considered non-standard and are not relayed, and eventually this rule may extend to enforcing that the stack have exactly one item after execution. However doing that may interfere with later extensions to Bitcoin.</p>
</blockquote>
<p>（不太理解，直接翻译了）比特币的签名算法不会对任何一个解锁脚本创建签名。尽管对整个解锁脚本签名是不可能的，签名会对自己进行签名，这意味着额外的数据可以被添加。额外的数据将会被推到栈（脚本运行时的用的栈）的被需要的签名和公钥前面。相似地，OP_DROP可以被添加，造成栈在解锁脚本执行之前恰好如之前的情况一样（？？？）。</p>
<p>如何防止解锁脚本延展性也正在被考虑。现在，解锁脚本里有除了push操作以外的操作的交易是不标准的，也不会被转发。以后这个规则可能会扩展到强制栈必须在执行完后恰好只有一个元素。然而做这个可能性向比特币之后的扩展性。
　　</p>
<h2 id="segregated-witness">隔离见证（segregated witness）</h2>
<p>参考：
- <a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki">https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki</a>
- <a href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki">https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki</a></p>
<p>隔离见证（BIP141-BIP145描述）是软分叉。</p>
<p>隔离见证将交易格式从</p>
<pre><code>[nVersion][txins][txouts][nLockTime]
</code></pre>

<p>改成了</p>
<pre><code>[nVersion][marker][flag][txins][txouts][witness][nLockTime]
</code></pre>

<p><img alt="" src="https://raw.githubusercontent.com/furrybear/res/master/img/20190302101503.png" /></p>
<p>其中，maker和flag的目的是为了与老的交易区别，对于老的节点来说，新交易看起来是0输入的交易。原因见BIP144。</p>
<p>witness字段由一个或者多个witness field组成，每一个输入（txin）对应一个witness field。每个witness field开头有个字节var_int表示要在脚本执行前在栈里预先压入几个东西。witness不是脚本。witness field里主要是签名和公钥。</p>
<p>BIP141提供了两种新的交易类型P2WPKH（向隔离见证公钥哈希付款）和P2WSH（向隔离见证脚本付款）。</p>

  <br>
    

    
    
      
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../比特币脚本与地址学习笔记/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../比特币脚本与地址学习笔记/" class="btn btn-xs btn-link">
        比特币脚本与地址学习笔记
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../常见活跃区块链/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../常见活跃区块链/" class="btn btn-xs btn-link">
        常见区块链项目
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/furrybear/furrybear.github.io/edit/master/docs/1. Knowledge of Blockchain/比特币学习笔记.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>