<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="Furrybear">
    <link rel="canonical" href="https://furrybear.readthedocs.com/1. Knowledge of Blockchain/比特币脚本与地址学习笔记/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>比特币脚本与地址学习笔记 - Furrybear's Blog</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u6bd4\u7279\u5e01\u811a\u672c\u4e0e\u5730\u5740\u5b66\u4e60\u7b14\u8bb0", url: "#_top", children: [
              {title: "\u4e00\u4e9b\u6982\u5ff5\u7684\u90e8\u5206\u89e3\u91ca", url: "#_2" },
              {title: "\u7814\u7a76\u7684\u90e8\u5206\u7ed3\u8bba", url: "#_3" },
              {title: "\u975e\u9694\u79bb\u89c1\u8bc1\u4ea4\u6613", url: "#_4" },
              {title: "OP_RETURN", url: "#op_return" },
              {title: "\u7eaf\u9694\u79bb\u89c1\u8bc1\u4ea4\u6613", url: "#_9" },
              {title: "\u5c06P2WPKH\u548cP2WSH\u7684witness program\u5d4c\u5165P2SH\u8d4e\u56de\u811a\u672c\u7684\u90e8\u5206", url: "#p2wpkhp2wshwitness-programp2sh" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../比特币闪电网络学习笔记/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../比特币闪电网络学习笔记/" class="btn btn-xs btn-link">
        比特币闪电网络学习笔记
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../比特币学习笔记/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../比特币学习笔记/" class="btn btn-xs btn-link">
        比特币学习笔记
      </a>
    </div>
    
  </div>

    

    <h1 id="_1">比特币脚本与地址学习笔记</h1>
<h2 id="_2">一些概念的部分解释</h2>
<ul>
<li>非压缩式公钥：65字节，十六进制表示以04开头；</li>
<li>压缩式公钥：33字节，十六进制表示以02、03开头；</li>
<li>公钥哈希：20字节；</li>
<li>脚本哈希：20字节（或者32字节，但是没有见过实例）；</li>
<li>地址（由公钥哈希和脚本哈希组装和编码而来）：<ul>
<li>P2PKH型：十六进制以1开头，例如<code>1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2</code>，由公钥哈希组装和编码而来；</li>
<li>P2SH型：十六进制以3开头，例如<code>3J98t1WpEZ73CNmQviecrnyiWrnqRhWNLy</code>，由脚本哈希组装和编码而来；</li>
<li>bech32型：bc1来头，例如<code>bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq</code>，它是前两种地址的另一种表达格式，现在blockchain.info只在有“native witness program”的时候使用这种格式；</li>
</ul>
</li>
<li>签名：七十几字节（由第二个字节决定）；</li>
</ul>
<h2 id="_3">研究的部分结论</h2>
<p><img alt="" src="https://raw.githubusercontent.com/furrybear/res/master/img/20190302101309.png" /></p>
<h3 id="markerflag">非隔离见证交易（没有marker和flag的）</h3>
<ul>
<li>锁定脚本：<code>41&lt;非压缩式公钥（65字节）&gt;AC（1开头地址）</code></li>
<li>锁定脚本(不太确定)：（P2PK型多重签名)OP_2 &lt;公钥1&gt; &lt;公钥2&gt; &lt;公钥3&gt; OP_3 CHECKMULTISIG(0xAE)（1开头地址）</li>
<li>锁定脚本：76A914&lt;公钥哈希&gt;(20bytes)88AC（1开头地址）</li>
<li>锁定脚本：76A914&lt;公钥哈希&gt;(20bytes)87AC（1开头地址）</li>
<li>锁定脚本：A914&lt;脚本哈希&gt;(20bytes)87（3开头地址）</li>
<li>锁定脚本：6A&lt;data&gt;(40bytes?)（没有地址，资金锁住了）</li>
</ul>
<h3 id="markerflag_1">隔离见证交易（有marker和flag的）</h3>
<ul>
<li>锁定脚本：0014&lt;哈希&gt;(20bytes)（bc1开头地址）</li>
<li>锁定脚本：0014&lt;哈希&gt;(20bytes)（bc1开头地址）</li>
<li>锁定脚本：A914&lt;脚本哈希&gt;(20bytes)87（3开头地址）</li>
<li>锁定脚本：A914&lt;脚本哈希&gt;(20bytes)87（3开头地址）</li>
</ul>
<h2 id="_4">非隔离见证交易</h2>
<h3 id="p2pkhpay-to-public-key-hash">P2PKH（Pay-to-Public-Key-Hash）</h3>
<h4 id="_5">单签名（第一种）</h4>
<p>//解锁脚本：&lt;Signature&gt; &lt;Public Key&gt; OP_DUP OP_HASH160
锁定脚本：OP_DUP(0x76) OP_HASH160(0xA9) PUSHDATA20(0x14) &lt;Public Key Hash&gt;(20bytes) OP_EQUAL(0x87) OP_CHECKSIG(0xAC)</p>
<p>举例：（书上说有这种交易，没有找到实例）</p>
<h4 id="_6">单签名（第二种）</h4>
<p>//解锁脚本：&lt;Signature&gt; &lt;Public Key&gt; OP_DUP OP_HASH160
锁定脚本：OP_DUP(0x76) OP_HASH160(0xA9) PUSHDATA20(0x14) &lt;Public Key Hash&gt;(20bytes)  OP_EQUALVERIFY(0x88) OP_CHECKSIG(0xAC)</p>
<p>交易举例：99c2f5d3f1a1c89a4afa522361c55664e7777c71b02fd66cdf4e2ba190551d11、5a4ebf66822b0b2d56bd9dc64ece0bc38ee7844a23ff1d7320a88c5fdb2ad3e2</p>
<h3 id="p2pkpay-to-public-key">P2PK（Pay-to-Public-Key）</h3>
<h4 id="_7">单签名</h4>
<p>锁定脚本：PUSHDATA65BYTES(0x41) &lt;非压缩式公钥&gt;(65bytes) OP_CHECKSIG(0xAC)</p>
<p>(获取公钥后需要通过HASH160获得公钥哈希)</p>
<p>这是比特币最早的锁定脚本，coinbase一般是这种形式。</p>
<p>交易举例：创世区块的交易</p>
<h3 id="_8">多重签名</h3>
<p>锁定脚本：M PUSHDATA65(0x41) &lt;Public Key 1&gt; PUSHDATA65(0x41)
&lt;Public Key 2&gt; ... PUSHDATA65(0x41) &lt;Public Key N&gt; N OP_CHECKMULTISIG(0xAE)</p>
<p>（因为实例没有找到，这个锁定脚本形式有待验证，因为M是个操作数，但是之前没有操作码）</p>
<p>交易举例：（没找到）</p>
<h3 id="p2shpay-to-script-hash">P2SH（Pay-to-Script-Hash）</h3>
<p>赎回脚本（2-3）：
OP_2(0x52)
OP_PUSHDATA33BYTES(0x21)&lt;压缩式公钥1&gt;
OP_PUSHDATA33BYTES(0x21)&lt;压缩式公钥2&gt;
OP_PUSHDATA33BYTES(0x21)&lt;压缩式公钥3&gt;
OP_3(0x53)
OP_CHECKMULTISIG(0xAE)</p>
<p>解锁脚本：
OP_PUSHDATA?BYTES &lt;Sig1&gt;
OP_PUSHDATA?BYTES &lt;Sig2&gt;
OP_PUSHDATA?BYTES &lt;赎回脚本&gt;</p>
<p>锁定脚本：
HASH160(0xA9) 
PUSHDATA20(0x14) &lt;脚本哈希（赎回脚本的HASH160）&gt;(20bytes) OP_EQUAL(0x87)</p>
<p>举例：
txid为<code>521f7c6781ced91da6cc8eb4c64b283d2e99f98627daf8a3a0c60432d8e8f601</code>的输入</p>
<p>解锁脚本：</p>
<pre><code>00//这是要注意！这是什么？？？版本号？
OP_PUSHDATA71BYTES(0x47)
3044022027eec2f3081b87d271e32e126c9ccb4d2c4afa7ef14f7cff644723784b720ede02203e278a13e3544bd32abe6592e4e17a7331272db4a2b780113ed24e3ca3c37f3201//签名1
OP_PUSHDATA72BYTES(0x48)
30450221009e450de0b27f95db02d7ab8b5943c62b8e2f50eabfb017f509684c4f58892d7802203b8640c5f17b8e6239a65f66bbb26ea952dac9d0eefffd114d97878b2ac1da4f01//签名1
OP_PUSHDATA1(0x4c)69
OP_2(0x52)
OP_PUSHDATA33BYTES(0x21)
02ca355b567bff51c9b4a1c1590e25f685f8d12273efb7f7685a50e546786d0de7//公钥1
OP_PUSHDATA33BYTES(0x21)
03e5fa93cffa7533c6b68906c4a9b8665f5167f3ed95b830328835ca4d39b6495f//公钥2
OP_PUSHDATA33BYTES(0x21)
03ee6664f625e0a44fad0ad53ae1ecdc7c7239346b81514e8f87cfd2be4f8fec21//公钥3
OP_3(0x53) 
OP_CHECKMULTISIG(0xae)
</code></pre>

<p>锁定脚本：</p>
<pre><code>a914d0982dd391d674f101898e8500586019e01d9aa787
</code></pre>

<h2 id="op_return">OP_RETURN</h2>
<p>锁定脚本：OP_RETURN(0x6A) &lt;data&gt;(40bytes?)</p>
<p>输出不能被花费。</p>
<h2 id="_9">纯隔离见证交易</h2>
<p>witness_version在witness字段内，锁定脚本必然以一个版本号开头</p>
<h3 id="p2wpkhpay-to-witness-public-key-hash">P2WPKH（pay-to-witness-public-key-hash）</h3>
<p>witness: &lt;signature&gt; &lt;pubkey&gt;
解锁脚本: 空
锁定脚本: witness_version(0x00) PUSHDATA20BYTES(0x14) &lt;公钥哈希&gt;(20bytes)</p>
<p>交易举例：没有找到实例……</p>
<h3 id="p2wshpay-to-witness-script-hash">P2WSH（pay-to-witness-script-hash）</h3>
<p>witness: witness_version(0x00) OP_PUSHDATA?BYTES &lt;签名1&gt; OP_1 OP_PUSHDATA33BYTES &lt;压缩式公钥1&gt; OP_PUSHDATA33BYTES &lt;压缩式公钥2&gt; OP_2 OP_CHECKMULTISIG(0xAE)
解锁脚本: 空
锁定脚本1: witness_version(0x00) PUSHDATA32BYTES(0x20) &lt;脚本哈希&gt;(32bytes)
锁定脚本2: witness_version(0x00) PUSHDATA20BYTES(0x14) &lt;脚本哈希&gt;(20bytes)
锁定脚本3: witness_version(非0x00) PUSHDATA任意BYTES &lt;脚本哈希&gt;(任意bytes)
(注意：P2SH的脚本哈希只有20字节，这里可以20字节或者32字节，32字节是为了防碰撞)</p>
<p>交易举例：txid为<code>d38f496e1004895c52d35bfe392800024b78b40e30dd063c4728058088ea0620</code>交易的输入</p>
<p>witness：</p>
<pre><code>04//？？
witness_version(0x00)
47
304402203f87ea2cb39bf7b57f0ada40cfa7178a7b11548767d17be57e0e3a9ed818e53902202323afa3875a9917bf8227051ea5805ea5bc7a71f1ef8176884964a278aa2c2b01//签名
47
304402201055076d4a5284509a8c3e01abbe5e34e4fd79fe823914821bcaa7924333e0e40220495237c0d9acd7f16357de8c89e4eaab620ce5d26b810214e96272f4cf27b54e01//签名
OP_VERIFY(0x69)
OP_2(0x52)
21
0375e00eb72e29da82b89367947f29ef34afb75e8654f6ea368e0acdfd92976b7c//公钥
21
03a1b26313f430c4b15bb1fdce663207659d8cac749a0e53d70eff01874496feff//公钥
21
03c96d495bfdd5ba4145e3e046fee45e84a8a48ad05bd8dbb395c011a32cf9f880//公钥
OP_3(0x53)
ae
</code></pre>

<h2 id="p2wpkhp2wshwitness-programp2sh">将P2WPKH和P2WSH的witness program嵌入P2SH赎回脚本的部分</h2>
<p>witness_version在解锁脚本内。</p>
<h3 id="p2wpkh-nested-in-bip16-p2sh">P2WPKH nested in BIP16 P2SH</h3>
<p>witness: &lt;signature&gt; &lt;pubkey&gt;
解锁脚本: PUSHDATA22BYTES(0x16) witness_version(00)PUSHDATA22BYTES(0x14) &lt;公钥哈希&gt;(20bytes)
锁定脚本: OP_HASH160(0xA9) PUSHDATA20BYTES(0x14) &lt;脚本哈希&gt;(20bytes) OP_EQUAL(0x87)</p>
<p>举例：交易c420d6cf09973d4a539cb17acdc42a3a89a89e0d6e28938a37951085d8433125的输出</p>
<h3 id="p2wsh-nested-in-bip16-p2sh">P2WSH nested in BIP16 P2SH</h3>
<p>witness:0 &lt;signature1&gt; &lt;1 &lt;pubkey1&gt; &lt;pubkey2&gt; 2 CHECKMULTISIG&gt;
解锁脚本1: PUSHDATA34BYTES(0x22) witness_version(00) PUSHDATA32BYTES(0x20) &lt;脚本哈希&gt; (32bytes)
解锁脚本2: PUSHDATA22BYTES(0x16) witness_version(00) PUSHDATA20BYTES(0x14) &lt;脚本哈希&gt; (20bytes)
锁定脚本: OP_HASH160(0xa9) OP_PUSHDATA20(0x14) &lt;20-byte-hash&gt; OP_EQUAL(0x87)</p>
<p>交易举例：
- 4967d6427b17a17e91b524e9a4f8a810182c5f9995fd07fe2eab71d9cc96ecc0</p>

  <br>
    

    
    
      
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../比特币闪电网络学习笔记/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../比特币闪电网络学习笔记/" class="btn btn-xs btn-link">
        比特币闪电网络学习笔记
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../比特币学习笔记/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../比特币学习笔记/" class="btn btn-xs btn-link">
        比特币学习笔记
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/furrybear/blog/edit/master/docs/1. Knowledge of Blockchain/比特币脚本与地址学习笔记.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>